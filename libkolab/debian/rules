#!/usr/bin/make -f

PHPAPI := $(shell php-config --phpapi)
PHPBIN := $(shell php-config --php-binary)
PHPEXT := $(shell php-config --extension-dir)
PHPINC := $(shell php-config --include-dir)
PYTHON_SITEARCH := $(shell python -c 'from distutils.sysconfig import get_python_lib; print get_python_lib(1)')

PHP_VERSIONS=7.3 7.2 7.1 7.0 5.6

export DH_VERBOSE=1
export DH_OPTIONS=-v

export DEB_LDFLAGS_MAINT_APPEND="-Wl,--as-needed"

%:
	dh $@ --parallel --with python2

override_dh_gencontrol:
	echo "php:Depends=phpapi-${PHPAPI}" >> debian/php-kolab.substvars

	if [ -f /etc/plesk-release ] ; then \
		for version in $(PHP_VERSIONS) ; do \
			if [ ! -f "/opt/plesk/php/$${version}/bin/php-config" ] ; then \
				continue ; \
			fi ; \
			shver=$$(echo $${version} | sed -e 's/\.//g') ; \
			echo "" >> debian/control ; \
			echo "Package: plesk-php$${shver}-kolab" >> debian/control ; \
			echo "Architecture: amd64" >> debian/control ; \
			echo "Depends: libkolab2, plesk-php$${shver}" >> debian/control ; \
			echo "Description: Kolab library bindings for Plesk PHP $${version}" >> debian/control ; \
			echo "" >> debian/control ; \
			sed -i -e "/Files:/ i\
 plesk-php$${shver}-kolab deb web extra" debian/control ; \
			echo "opt/plesk/php/$${version}/lib/php/modules/*.so" >> debian/plesk-php$${shver}-kolab.install ; \
			echo "opt/plesk/php/$${version}/share/php/kolab.php" >> debian/plesk-php$${shver}-kolab.install ; \
			echo "debian/kolab.ini opt/plesk/php/$${version}/etc/php.d" > debian/plesk-php$${shver}-kolab.install ; \
		done ; \
	fi

	dh_gencontrol

override_dh_auto_build:
	if [ -f /etc/plesk-release ] ; then \
		for version in $(PHP_VERSIONS) ; do \
			if [ ! -f "/opt/plesk/php/$${version}/bin/php-config" ] ; then \
				continue ; \
			fi ; \
			if [ $$(/opt/plesk/php/$${version}/bin/php-config --vernum) -gt 70000 ]; then \
				sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php7 -I/g' cmake/modules/SWIGUtils.cmake ; \
			else \
				sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php5 -I/g' cmake/modules/SWIGUtils.cmake ; \
			fi ; \
			dh_auto_build --builddirectory php-$${version} ; \
		done ; \
	fi

	if [ $$(php-config --vernum) -gt 70000 ]; then \
		sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php7 -I/g' cmake/modules/SWIGUtils.cmake ; \
	else \
		sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php5 -I/g' cmake/modules/SWIGUtils.cmake ; \
	fi

	dh_auto_build

override_dh_auto_configure:
	if [ -f /etc/plesk-release ] ; then \
		for version in $(PHP_VERSIONS) ; do \
			if [ ! -f "/opt/plesk/php/$${version}/bin/php-config" ] ; then \
				continue ; \
			fi ; \
			if [ $$(/opt/plesk/php/$${version}/bin/php-config --vernum) -gt 70000 ]; then \
				sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php7 -I/g' cmake/modules/SWIGUtils.cmake ; \
			else \
				sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php5 -I/g' cmake/modules/SWIGUtils.cmake ; \
			fi ; \
			dh_auto_configure --builddirectory php-$${version} -- \
				-DLIB_INSTALL_DIR=/usr/lib \
				-DSWIG=/usr/bin/swig \
				-DUSE_LIBCALENDARING=ON \
				-DPHP_BINDINGS=ON \
				-DPHP_INCLUDE_DIR=$$(/opt/plesk/php/$${version}/bin/php-config --include-dir) \
				-DPHP_CONFIG_EXECUTABLE=/opt/plesk/php/$${version}/bin/php-config \
				-DPHP_EXECUTABLE=/opt/plesk/php/$${version}/bin/php \
				-DPHP_INCLUDE_DIR=$$(/opt/plesk/php/$${version}/bin/php-config --include-dir) \
				-DPHP_INSTALL_DIR=$$(/opt/plesk/php/$${version}/bin/php-config --extension-dir) ; \
		done ; \
	fi

	if [ $$(php-config --vernum) -gt 70000 ]; then \
		sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php7 -I/g' cmake/modules/SWIGUtils.cmake ; \
	else \
		sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php5 -I/g' cmake/modules/SWIGUtils.cmake ; \
	fi

	dh_auto_configure -- \
		-DLIB_INSTALL_DIR=/usr/lib \
		-DPHP_BINDINGS=ON \
		-DPHP_INSTALL_DIR=$(PHPEXT) \
		-DPHP_EXECUTABLE=$(PHPBIN) \
		-DPHP_INCLUDE_DIR=$(PHPINC) \
		-DPYTHON_BINDINGS=ON \
		-DPYTHON_INSTALL_DIR=$(PYTHON_SITEARCH) \
		-DUSE_LIBCALENDARING=ON

override_dh_install:
	# Install the PHP modules manually, because they depend on PHP the API version,
	# which has to be determined dynamically, so we can't put it into an .install file.
	mkdir -p debian/tmp/usr/share/php
	mv debian/tmp/$(PHPEXT)/*.php debian/tmp/usr/share/php/.
	echo "$(PHPEXT)" >> debian/php-kolab.install

	# Put kolab.ini into place
	if [ -d "/etc/php/7.3/mods-available" ]; then \
		echo "debian/kolab.ini etc/php/7.3/mods-available" >> debian/php-kolab.install ; \
	elif [ -d "/etc/php/7.2/mods-available" ]; then \
		echo "debian/kolab.ini etc/php/7.2/mods-available" >> debian/php-kolab.install ; \
	elif [ -d "/etc/php/7.1/mods-available" ]; then \
		echo "debian/kolab.ini etc/php/7.1/mods-available" >> debian/php-kolab.install ; \
	elif [ -d "/etc/php/7.0/mods-available" ]; then \
		echo "debian/kolab.ini etc/php/7.0/mods-available" >> debian/php-kolab.install ; \
	elif [ -d "/etc/php/mods-available" ]; then \
		echo "debian/kolab.ini etc/php/mods-available" >> debian/php-kolab.install ; \
	else \
		echo "debian/kolab.ini etc/php5/mods-available" >> debian/php-kolab.install ; \
	fi

	touch debian/tmp/$(PYTHON_SITEARCH)/kolab/__init__.py

	if [ -f /etc/plesk-release ]; then \
		for version in $(PHP_VERSIONS) ; do \
			if [ ! -f "/opt/plesk/php/$${version}/bin/php-config" ]; then \
				continue ; \
			fi ; \
			if [ $$(/opt/plesk/php/$${version}/bin/php-config --vernum) -gt 70000 ]; then \
				sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php7 -I/g' cmake/modules/SWIGUtils.cmake ; \
			else \
				sed -r -i -e 's/-c\+\+ -php[0-9]? -I/-c++ -php5 -I/g' cmake/modules/SWIGUtils.cmake ; \
			fi ; \
			shver=$$(echo $${version} | sed -e 's/\.//g') ; \
			make -C php-$${version} install DESTDIR=$(PWD)/debian/plesk-php$${shver}-kolab/ ; \
			mkdir -p debian/plesk-php$${shver}-kolab/opt/plesk/php/$${version}/etc/php.d/ ; \
			mkdir -p debian/plesk-php$${shver}-kolab/opt/plesk/php/$${version}/share/php/ ; \
			cp -a debian/kolab.ini debian/plesk-php$${shver}-kolab/opt/plesk/php/$${version}/etc/php.d/ ; \
			mv debian/plesk-php$${shver}-kolab$$(/opt/plesk/php/$${version}/bin/php-config --extension-dir)/kolab*.php \
				debian/plesk-php$${shver}-kolab/opt/plesk/php/$${version}/share/php/. ; \
			rm -rf debian/plesk-php$${shver}-kolab/usr/ ; \
		done ; \
	fi

	# Install the packages
	dh_install --list-missing

override_dh_auto_test:
	dh_auto_test || :

override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info
